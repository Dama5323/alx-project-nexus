{% extends "base.html" %}
{% load static %}

{% block content %}
<h1>Our Products</h1>

{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="product-grid">
  {% for product in products %}
  <div class="product-card">
    {# FIX: use product.slug instead of id to match URL pattern #}
    <a href="{% url 'products:detail' product.slug %}" class="product-link">
      <div class="product-image-container">
        <img src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'images/default-product.png' %}{% endif %}" 
             alt="{{ product.name }}"
             width="300"
             height="300"
             loading="lazy">
      </div>
      <div class="product-info">
        <h3>{{ product.name }}</h3>
        <p class="price">${{ product.price }}</p>
        {% if product.stock <= 0 %}
          <p class="stock out-of-stock">Out of Stock</p>
        {% else %}
          <p class="stock in-stock">In Stock</p>
        {% endif %}
      </div>
    </a>
    
    {# Cart add URL can still use ID if your cart:add route is ID-based #}
    <form action="{% url 'cart:add' product.id %}" method="post" class="add-to-cart-form" aria-label="Add {{ product.name }} to cart">
      {% csrf_token %}
      <div class="quantity-selector">
        <label for="quantity-{{ product.id }}">Qty:</label>
        <input type="number" 
               id="quantity-{{ product.id }}" 
               name="quantity" 
               value="1" 
               min="1"
               max="{% if product.stock > 0 %}{{ product.stock }}{% else %}1{% endif %}"
               {% if product.stock <= 0 %}disabled{% endif %}>
      </div>
      <button type="submit" class="add-to-cart-btn" {% if product.stock <= 0 %}disabled{% endif %}>
        {% if product.stock <= 0 %}Out of Stock{% else %}Add to Cart{% endif %}
      </button>
    </form>
  </div>
  {% empty %}
  <div class="no-products">
    <p>No products available at this time.</p>
  </div>
  {% endfor %}
</div>
{% endblock %}
