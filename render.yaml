services:
  - type: web
    plan: free  
    name: djangocommerce-backend-production
    runtime: python 
    region: oregon 
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      python manage.py collectstatic --noinput
    startCommand: >-
      python manage.py migrate --noinput && \
      gunicorn DjangoCommerce.wsgi:application \
        --bind 0.0.0.0:$PORT \
        --workers $WEB_CONCURRENCY \
        --timeout 120 \
        --keep-alive 5
    healthCheckPath: /health/
    envVars:
      # Core Configuration
      - key: ENVIRONMENT
        value: production
      - key: DJANGO_SETTINGS_MODULE
        value: DjangoCommerce.settings.production
      
      # Database
      - key: DATABASE_URL
        fromDatabase:
          name: djangocommerce-db
          property: connectionString
      
      # Security
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "False"
      - key: ALLOWED_HOSTS
        value: "djangocommerce-backend-production.onrender.com,*.onrender.com"
      - key: CSRF_TRUSTED_ORIGINS
        value: "https://djangocommerce-backend-production.onrender.com"
      
      # Performance
      - key: WEB_CONCURRENCY
        value: "2"  # Reduced to 2 for free tier stability
      - key: GUNICORN_TIMEOUT
        value: "120"
      
      # Static Files
      - key: WHITENOISE_MANIFEST_STRICT
        value: "False"
      - key: DISABLE_COLLECTSTATIC
        value: "0"

    staticFiles:
      - path: /static/
        destination: /opt/render/project/src/staticfiles/